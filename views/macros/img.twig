{% macro picture(thumbnail, sizes=[1920], lqip_size=40, alt, class, quality=100, img_styles=[], attrs={}) %}

	{% set pathinfo = thumbnail.pathinfo %}
	{% set sizes = sizes is iterable ? sizes|sort : sizes %}
	{% set loading = attrs.loading|default('lazy') %}
	{% set eager = loading == 'eager' %}
	{% set sizes_attr = attrs.sizes|default('100vw') %}

	{% if pathinfo.extension|lower == 'svg' %}
		<img
			src="{{ (sizes|last is iterable ? thumbnail.src|resize(sizes|last[0], sizes|last[1]) : thumbnail.src|resize(sizes|last))|relative }}"
			alt="{{ alt|default(thumbnail.alt)|e('html_attr') }}"
			class="{{ class|e('html_attr') }} {{ class|e('html_attr') }}--svg"
			loading="{{ loading|e('html_attr') }}"
			decoding="{{ attrs.decoding|default('async')|e('html_attr') }}"
			{% if attrs.fetchpriority is defined %}
				fetchpriority="{{ attrs.fetchpriority|e('html_attr') }}"
			{% endif %}
			{% if img_styles %}
				style="{{ img_styles|join(';') }};"
			{% endif %}
		>
	{% else %}
		<picture class="{{ class|e('html_attr') }}--picture">
			{% if thumbnail.src %}
				<source
					type="image/webp"
					{% if eager %}
						srcset="
						{% for size in sizes %}
							{% if size is iterable %}
								{{ thumbnail.src|resize(size[0], size[1])|towebp(quality)|relative }} {{ size[0] }}w{% if not loop.last %},{% endif %}
							{% else %}
								{{ thumbnail.src|resize(size)|towebp(quality)|relative }} {{ size }}w{% if not loop.last %},{% endif %}
							{% endif %}
						{% endfor %}
						"
						sizes="{{ sizes_attr|e('html_attr') }}"
					{% else %}
						srcset="{{ (lqip_size is iterable ? thumbnail.src|resize(lqip_size[0], lqip_size[1]) : thumbnail.src|resize(lqip_size))|towebp(quality)|relative }}"
						class="blur-up lazyload"
						data-srcset="
						{% for size in sizes %}
							{% if size is iterable %}
								{{ thumbnail.src|resize(size[0], size[1])|towebp(quality)|relative }} {{ size[0] }}w{% if not loop.last %},{% endif %}
							{% else %}
								{{ thumbnail.src|resize(size)|towebp(quality)|relative }} {{ size }}w{% if not loop.last %},{% endif %}
							{% endif %}
						{% endfor %}
						"
					{% endif %}
				>
			{% endif %}

			{{ _self.img(thumbnail, sizes, lqip_size, alt, class, quality, img_styles, attrs) }}
		</picture>
	{% endif %}
{% endmacro %}

{% macro img(thumbnail, sizes=[1920], lqip_size=40, alt, class, quality, img_styles, attrs={}) %}

	{% if thumbnail.src %}

		{% set last_size = sizes|last %}
		{% set target_w = last_size is iterable ? last_size[0] : last_size %}
		{% set target_h = last_size is iterable ? last_size[1] : null %}
		{% set width = (target_w / 2)|round %}
		{% set loading = attrs.loading|default('lazy') %}
		{% set eager = loading == 'eager' %}
		{% set sizes_attr = attrs.sizes|default('100vw') %}

		{% if target_h %}
			{% set height = (target_h / 2)|round %}
		{% else %}
			{% if thumbnail.width and thumbnail.height and thumbnail.width > 0 %}
				{% set ratio = thumbnail.height / thumbnail.width %}
				{% set height = (width * ratio)|round %}
			{% else %}
				{% set height = 1 %}
			{% endif %}
		{% endif %}

		{% if height < 1 %}
			{% set height = 1 %}
		{% endif %}

		<img
			width="{{ width }}"
			height="{{ height }}"
			src="{{ (last_size is iterable ? thumbnail.src|resize(last_size[0], last_size[1]) : thumbnail.src|resize(last_size))|relative }}"
			{% if eager %}
				srcset="
				{% for size in sizes %}
					{% if size is iterable %}
						{{ thumbnail.src|resize(size[0], size[1])|relative }} {{ size[0] }}w{% if not loop.last %},{% endif %}
					{% else %}
						{{ thumbnail.src|resize(size)|relative }} {{ size }}w{% if not loop.last %},{% endif %}
					{% endif %}
				{% endfor %}
				"
				sizes="{{ sizes_attr|e('html_attr') }}"
				class="{{ class|e('html_attr') }}"
			{% else %}
				srcset="{{ (lqip_size is iterable ? thumbnail.src|resize(lqip_size[0], lqip_size[1]) : thumbnail.src|resize(lqip_size))|relative }}"
				class="blur-up lazyload {{ class|e('html_attr') }}"
				data-sizes="auto"
				data-src="{{ (last_size is iterable ? thumbnail.src|resize(last_size[0], last_size[1]) : thumbnail.src|resize(last_size))|relative }}"
				data-srcset="
				{% for size in sizes %}
					{% if size is iterable %}
						{{ thumbnail.src|resize(size[0], size[1])|relative }} {{ size[0] }}w{% if not loop.last %},{% endif %}
					{% else %}
						{{ thumbnail.src|resize(size)|relative }} {{ size }}w{% if not loop.last %},{% endif %}
					{% endif %}
				{% endfor %}
				"
			{% endif %}
			alt="{{ alt|default(thumbnail.alt)|e('html_attr') }}"
			{% if eager %}
				loading="eager"
			{% endif %}
			decoding="{{ attrs.decoding|default('async')|e('html_attr') }}"
			{% if attrs.fetchpriority is defined %}
				fetchpriority="{{ attrs.fetchpriority|e('html_attr') }}"
			{% endif %}
			{% if img_styles %}
				style="{{ img_styles|join(';') }};"
			{% endif %}
		>

	{% else %}

		{% set last_size = sizes|last %}
		{% set w = last_size is iterable ? last_size[0] : last_size %}
		{% set h = last_size is iterable ? last_size[1] : 0 %}
		<img
			src="{{ 'https://placehold.co/%dx%d/333/fff?text=%s'|format(w, h, alt|striptags|upper|url_encode) }}"
			alt="{{ alt|default(thumbnail.alt)|e('html_attr') }}"
			class="{{ class|e('html_attr') }}"
			{% if attrs.loading|default('lazy') == 'eager' %}
				loading="eager"
			{% endif %}
			decoding="{{ attrs.decoding|default('async')|e('html_attr') }}"
			{% if img_styles %}
				style="{{ img_styles|join(';') }};"
			{% endif %}
		>

	{% endif %}

{% endmacro %}
